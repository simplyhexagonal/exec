{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import { exec as execCallback } from 'child_process';\n\nimport elean from '@simplyhexagonal/elean';\nimport MonoContext from '@simplyhexagonal/mono-context';\n\n// @ts-ignore\nexport { version } from '../package.json';\n\nexport interface ExecOptions {\n  logStdout?: boolean;\n  logStderr?: boolean;\n  loggerInstance?: any;\n}\n\nexport interface ExecResult {\n  exitCode:number;\n  stdoutOutput:string;\n  stderrOutput:string;\n}\n\nexport class ExecError extends Error {\n  exitCode:number;\n  stdoutOutput:string;\n  stderrOutput:string;\n\n  constructor(message:string, exitCode:number, stdoutOutput:string, stderrOutput:string) {\n    super(message);\n\n    this.exitCode = exitCode;\n    this.stdoutOutput = stdoutOutput;\n    this.stderrOutput = stderrOutput;\n  };\n}\n\nconst { REALTIME_LOG } = process.env;\n\nconst shouldRealtimeLog = elean(REALTIME_LOG);\n\nconst realtimeLog = (...args: any[]) => {\n  const logger = MonoContext.getStateValue('logger') || console;\n\n  if (shouldRealtimeLog) {\n    logger.debug(...args);\n  }\n}\n\nconst exec = (\n  command: string,\n  options?: ExecOptions,\n) => {\n  const {\n    logStdout,\n    logStderr,\n    loggerInstance,\n  } = options || {};\n\n  const logger = loggerInstance || MonoContext.getStateValue('logger') || console;\n\n  const child = execCallback(command);\n\n  const {stdout, stderr} = child;\n\n  const stdoutChunks: any[] = [];\n  const stderrChunks: any[] = [];\n\n  let stdoutOutput = '';\n  let stderrOutput = '';\n\n  stdout?.on('data', (chunk) => {\n    logStdout && realtimeLog(chunk);stdoutChunks.push(Buffer.from(chunk));\n  });\n  stderr?.on('data', (chunk) => {\n    logStderr && realtimeLog(chunk);stderrChunks.push(Buffer.from(chunk));\n  });\n\n  const stdoutPromise = new Promise<void>((resolve, reject) => {\n    stdout?.on('end', () => {\n      stdoutOutput = Buffer.concat(stdoutChunks).toString('utf8');\n      resolve();\n    });\n  });\n\n  const stderrPromise = new Promise<void>((resolve, reject) => {\n    stderr?.on('end', () => {\n      stderrOutput = Buffer.concat(stderrChunks).toString('utf8');\n      resolve();\n    });\n  });\n\n  return {\n    process: child,\n    promise: new Promise<ExecResult>(\n      (resolve, reject) => {\n        child.addListener('error', reject);\n        child.addListener('exit', async (exitCode: number) => {\n          await stdoutPromise;\n          await stderrPromise;\n\n          if (stdoutOutput && !shouldRealtimeLog && logStdout) {\n            logger.debug(stdoutOutput);\n          }\n\n          if (exitCode === 0 && stderrOutput) {\n            await logger.warn(stderrOutput);\n          }\n\n          if (exitCode !== 0) {\n            logger.debug(`Error exit code of command \"${command}\" is: ${exitCode}`);\n\n            reject(\n              new ExecError(\n                stderrOutput || stdoutOutput,\n                exitCode,\n                stdoutOutput,\n                stderrOutput\n              )\n            );\n          }\n\n          resolve({\n            exitCode,\n            stdoutOutput,\n            stderrOutput,\n          });\n        });\n      }\n    )\n  };\n};\n\nexport default exec;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BAAqC;AAErC,mBAAkB;AAClB,0BAAwB;;;;;;AAiBjB,8BAAwB,MAAM;AAAA,EAKnC,YAAY,SAAgB,UAAiB,cAAqB,cAAqB;AACrF,UAAM;AAEN,SAAK,WAAW;AAChB,SAAK,eAAe;AACpB,SAAK,eAAe;AAAA;AAAA;AAIxB,IAAM,EAAE,iBAAiB,QAAQ;AAEjC,IAAM,oBAAoB,0BAAM;AAEhC,IAAM,cAAc,IAAI,SAAgB;AACtC,QAAM,SAAS,4BAAY,cAAc,aAAa;AAEtD,MAAI,mBAAmB;AACrB,WAAO,MAAM,GAAG;AAAA;AAAA;AAIpB,IAAM,OAAO,CACX,SACA,YACG;AACH,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA;AAAA,MACE,WAAW;AAEf,QAAM,SAAS,kBAAkB,4BAAY,cAAc,aAAa;AAExE,QAAM,QAAQ,+BAAa;AAE3B,QAAM,EAAC,QAAQ,WAAU;AAEzB,QAAM,eAAsB;AAC5B,QAAM,eAAsB;AAE5B,MAAI,eAAe;AACnB,MAAI,eAAe;AAEnB,UAAQ,GAAG,QAAQ,CAAC,UAAU;AAC5B,iBAAa,YAAY;AAAO,iBAAa,KAAK,OAAO,KAAK;AAAA;AAEhE,UAAQ,GAAG,QAAQ,CAAC,UAAU;AAC5B,iBAAa,YAAY;AAAO,iBAAa,KAAK,OAAO,KAAK;AAAA;AAGhE,QAAM,gBAAgB,IAAI,QAAc,CAAC,SAAS,WAAW;AAC3D,YAAQ,GAAG,OAAO,MAAM;AACtB,qBAAe,OAAO,OAAO,cAAc,SAAS;AACpD;AAAA;AAAA;AAIJ,QAAM,gBAAgB,IAAI,QAAc,CAAC,SAAS,WAAW;AAC3D,YAAQ,GAAG,OAAO,MAAM;AACtB,qBAAe,OAAO,OAAO,cAAc,SAAS;AACpD;AAAA;AAAA;AAIJ,SAAO;AAAA,IACL,SAAS;AAAA,IACT,SAAS,IAAI,QACX,CAAC,SAAS,WAAW;AACnB,YAAM,YAAY,SAAS;AAC3B,YAAM,YAAY,QAAQ,OAAO,aAAqB;AACpD,cAAM;AACN,cAAM;AAEN,YAAI,gBAAgB,CAAC,qBAAqB,WAAW;AACnD,iBAAO,MAAM;AAAA;AAGf,YAAI,aAAa,KAAK,cAAc;AAClC,gBAAM,OAAO,KAAK;AAAA;AAGpB,YAAI,aAAa,GAAG;AAClB,iBAAO,MAAM,+BAA+B,gBAAgB;AAE5D,iBACE,IAAI,UACF,gBAAgB,cAChB,UACA,cACA;AAAA;AAKN,gBAAQ;AAAA,UACN;AAAA,UACA;AAAA,UACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQZ,IAAO,cAAQ;",
  "names": []
}
